<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">

	<title>WebSocket Test</title>
	<script src="http://www.codebase.es/riffwave/riffwave.js"></script>
	<script src="https://cdn.socket.io/socket.io-1.2.0.js"></script>
	<script src="http://www.jasondavies.com/d3.min.js"></script>
	<script src="http://www.jasondavies.com/wordcloud/d3.layout.cloud.js"></script>
	<script src="http://code.jquery.com/jquery-2.1.3.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.7.0/underscore-min.js"></script>
	<script src="fade.js"></script>
	<script language="javascript" type="text/javascript">
		function buildTagCloud(words) {
			var fill = d3.scale.category20();
			d3.layout.cloud().size([$(document).height()*0.9, $(document).width()*0.9])
					.words(words)
					.padding(5)
					.rotate(function () {
						return ~~(Math.random() * 2) * 90;
					})
					.font("Impact")
					.fontSize(function (d) {
						return d.size;
					})
					.on("end", draw)
					.start();
			function draw(words) {
				d3.select("svg").html("")
						.attr("width", $(document).width()*0.9)
						.attr("height", $(document).height()*0.9)
						.append("g")
						.attr("transform", "translate("+($(document).width()*0.45)+","+($(document).height()*0.45)+")")
						.selectAll("text")
						.data(words)
						.enter().append("text")
						.style("font-size", function (d) {
							return d.size + "px";
						})
						.style("font-family", "Impact")
						.style("fill", function (d, i) {
							return fill(i);
						})
						.attr("text-anchor", "middle")
						.attr("transform", function (d) {
							return "translate(" + [d.x, d.y] + ")rotate(" + d.rotate + ")";
						})
						.text(function (d) {
							return d.text;
						});
			}
		}
		;
		volume = 0.5;
		var activeAudio = 0;
		var audio = [new Audio(), new Audio(), new Audio()]; // Create the HTML5 audio element
		var play = function (freq) {
			var wave = new RIFFWAVE();
			var data = [];

			wave.header.sampleRate = 44100; // Set sample rate to 44KHz
			wave.header.numChannels = 1;

			var i = 0;
			while (i < 100000) {
				var t = i / wave.header.sampleRate;
				data[i++] = 128 + Math.round(127 * Math.sin(freq * t * 2 * Math.PI));
			}

			wave.Make(data);
			audio[activeAudio].src = wave.dataURI;
			audio[activeAudio].volume = volume;
			audio[activeAudio].play();
			if(activeAudio == audio.length - 1){
				activeAudio = 0;
			} else {
				activeAudio = activeAudio + 1;
			}
		};

		var wsUri = location.origin;
		var socket = io.connect(wsUri);
		var words = [];

		var throttledWordCloudUpdate = _.throttle(function() {
			buildTagCloud(words);
		}, 1500);

		socket.on('connect', function () {
			console.log("connection");
		});
		socket.on('error', function () {
			console.error("error");
		});
		socket.on('tweet', function (t) {
			play(t.tone);
			words = t.words;
			throttledWordCloudUpdate();
		});
	</script>
</head>

<body>
<h2>Twitter music</h2>
<svg />
</body>
</html>