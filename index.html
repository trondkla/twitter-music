<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">

	<title>WebSocket Test</title>
	<script src="http://www.codebase.es/riffwave/riffwave.js"></script>
	<script src="https://cdn.socket.io/socket.io-1.2.0.js"></script>
	<script src="http://www.jasondavies.com/d3.min.js"></script>
	<script src="http://www.jasondavies.com/wordcloud/d3.layout.cloud.js"></script>
	<script src="http://code.jquery.com/jquery-2.1.3.min.js"></script>
	<script src="fade.js"></script>
	<script language="javascript" type="text/javascript">
		function buildTagCloud(words) {
			var fill = d3.scale.category20();
			d3.layout.cloud().size([1000, 1000])
					.words(words)
					.padding(5)
					.rotate(function () {
						return ~~(Math.random() * 2) * 90;
					})
					.font("Impact")
					.fontSize(function (d) {
						return d.size;
					})
					.on("end", draw)
					.start();
			function draw(words) {
				d3.select("body").append("svg")
						.attr("width", 1000)
						.attr("height", 1000)
						.append("g")
						.attr("transform", "translate(500,500)")
						.selectAll("text")
						.data(words)
						.enter().append("text")
						.style("font-size", function (d) {
							return d.size + "px";
						})
						.style("font-family", "Impact")
						.style("fill", function (d, i) {
							return fill(i);
						})
						.attr("text-anchor", "middle")
						.attr("transform", function (d) {
							return "translate(" + [d.x, d.y] + ")rotate(" + d.rotate + ")";
						})
						.text(function (d) {
							return d.text;
						});
			}
		}
		;
		volume = 0.5;
		var play = function (freq) {
			var audio = new Audio(); // Create the HTML5 audio element
			var wave = new RIFFWAVE();
			var data = [];

			wave.header.sampleRate = 44100; // Set sample rate to 44KHz
			wave.header.numChannels = 1;

			var i = 0;
			while (i < 1000) {
				var t = i / wave.header.sampleRate;
				data[i++] = 128 + Math.round(127 * Math.sin(freq * t * 2 * Math.PI));
			}

			wave.Make(data);
			audio.src = wave.dataURI;
			audio.volume = volume;
			fadeIn(audio, 250, 1, 1);
			fadeOut(audio, 250, 0, 1);
		}

		//var wsUri = "ws://localhost:8000/";
		var wsUri = location.origin.replace(/^http/, 'ws');
		var socket = io(wsUri);

		socket.on('connect', function () {
			console.log("connection");
		});
		socket.on('error', function () {
			console.error("error");
		});
		socket.on('tweet', function (t) {
			play(t.tone);
		});
		$(document).ready(function(){
			buildTagCloud([{text: "this", size: 20}, {text: "is", size: 25}, {text: "a", size: 50}, {text: "test", size: 100}, {text: "Trond", size: 100}]);
			buildTagCloud([{text: "this", size: 20}, {text: "is", size: 25}, {text: "a", size: 50}, {text: "test", size: 100}, {text: "Trond", size: 100}]);
		});
	</script>
</head>

<body>
<h2>WebSocket Test</h2>
</body>
</html>